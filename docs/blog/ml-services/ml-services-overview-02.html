

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="ja" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="ja" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>[第5回] Amazon SageMaker の基本的な使い方を理解する (1) &mdash; technical notes  ドキュメント</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../_static/translations.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/my_theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="検索" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> technical notes
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../aws/aws.html">AWS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cloudnative/cloudnative.html">Cloud Native</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/python.html">Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../environment/environment.html">環境構築</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/testing.html">テスト</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../case/case.html">事例</a></li>
<li class="toctree-l1"><a class="reference internal" href="../blog.html">AWS ではじめる機械学習</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">technical notes</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
      <li>[第5回] Amazon SageMaker の基本的な使い方を理解する (1)</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/blog/ml-services/ml-services-overview-02.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="amazon-sagemaker-1">
<h1>[第5回] Amazon SageMaker の基本的な使い方を理解する (1)<a class="headerlink" href="#amazon-sagemaker-1" title="このヘッドラインへのパーマリンク">¶</a></h1>
<div class="section" id="id1">
<h2>はじめに<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="line-block">
<div class="line"><a class="reference external" href="https://news.mynavi.jp/itsearch/article/devsoft/4983">前回</a> は、ML サービスおよび Amazon SageMaker の概要と利用方法についてご説明させていただきました。</div>
<div class="line">図を用いて「開発」「学習」「推論」の流れを説明しましたが、今回の記事では、実際に Amazon SageMaker を使ってみたいと思います。</div>
<div class="line">今回は、下記を理解していただくことを目標に解説をしていきます。</div>
</div>
<ul class="simple">
<li><p>Amazon SageMaker を使って実際に「開発」を始めるまでの準備作業の流れがわかる。</p></li>
<li><p>Amazon SageMaker を使って、「開発」「学習」「推論」の流れがわかる。</p></li>
</ul>
</div>
<div class="section" id="amazon-sagemaker">
<h2>実際に Amazon SageMaker を使う<a class="headerlink" href="#amazon-sagemaker" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p><a class="reference external" href="https://aws.amazon.com/jp/getting-started/hands-on/build-train-deploy-machine-learning-model-sagemaker/">「機械学習モデルの構築およびトレーニング、デプロイ with Amazon SageMaker」</a> という簡単なチュートリアルがありますので、これをベースに進めたいと思います。</p>
<p>「自分が今何をしているのか」、「背後でどのような処理が行われているか」を整理しながら解説を進めていきます。
前回の記事で示した「開発」「学習」「推論」に沿った流れとなりますが、より細かい手順を示す点に注意してください。</p>
<div class="section" id="id3">
<h3>チュートリアルの概要<a class="headerlink" href="#id3" title="このヘッドラインへのパーマリンク">¶</a></h3>
<ul class="simple">
<li><p>Amazon SageMaker を使って、「開発」「学習」「推論」の一連の流れを体験できる。</p></li>
<li><p>XGBoost と呼ばれる機械学習アルゴリズムを利用して、二値分類を行う。</p></li>
<li><p>学習・推論に利用するデータは、カリフォルニア大学アーバイン校 (UCI) が公開しているオープンデータを利用する。</p></li>
<li><p>利用するデータは「Bank Marketing Data Set」と呼ばれる「ポルトガルの銀行マーケティングキャンペーン」のデータである。</p></li>
<li><p>データには大きく2種類の情報が記録されている。</p>
<ul>
<li><p>データ 1：「年齢」や「職業」といった銀行の顧客の属性情報など</p></li>
<li><p>データ 2：マーケティングを行った結果、その顧客が実際に「預金証書 (CD)」を申し込んだか否かのフラグ</p></li>
</ul>
</li>
<li><p>「データ 1」から機械学習アルゴリズムによって何らかのパターンを見出して、これから営業をかける顧客 (「データ 2」が未知の顧客) が「預金証書 (CD)」を申し込んでくれそうかどうかを分類する機械学習モデルを構築する。</p></li>
<li><p>「預金証書 (CD) を申し込んでくれそうな顧客」を重点的に営業をかけることによって営業活動を効率化することができる。顧客名簿の上から順に営業をかけるよりも顧客を獲得できる可能性が高まる。</p></li>
</ul>
</div>
<div class="section" id="id4">
<h3>今回の記事で実施すること<a class="headerlink" href="#id4" title="このヘッドラインへのパーマリンク">¶</a></h3>
<table class="docutils align-default">
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>工程</p></th>
<th class="head"><p>実施内容</p></th>
<th class="head"><p>連載回</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>開発</p></td>
<td><p>AWS マネジメントコンソールにログインする</p></td>
<td><p>第5回</p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>ノートブックインスタンスを作成する</p></td>
<td><p>第5回</p></td>
</tr>
<tr class="row-even"><td></td>
<td><p>学習・推論に利用するデータを格納するための S3 バケットを作成する</p></td>
<td><p>第5回</p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>学習・推論に利用するデータを準備する</p></td>
<td><p>第5回</p></td>
</tr>
<tr class="row-even"><td></td>
<td><p>学習用のコードを開発する</p></td>
<td><p>第5回</p></td>
</tr>
<tr class="row-odd"><td><p>学習</p></td>
<td></td>
<td><p>第6回</p></td>
</tr>
<tr class="row-even"><td><p>推論</p></td>
<td></td>
<td><p>第7回</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id5">
<h3>前提<a class="headerlink" href="#id5" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>今回の記事の内容を実施する際の前提を下記に示します。</p>
<ul class="simple">
<li><p>本番環境 (商用サービスが稼働する AWS アカウント) ではなく、開発環境や検証環境で実施する。</p></li>
<li><p>「AWS アカウントの取得」と「IAM ユーザの作成」を未実施の場合は、下記の Amazon SageMaker の開発者ガイドを参照して実施する。
IAM ユーザに管理者権限 (AdministratorAccess) を付与する手順となっているが、実際の業務では必要最小限の権限に制限してほしい。</p>
<ul>
<li><p><a class="reference external" href="https://docs.aws.amazon.com/ja_jp/sagemaker/latest/dg/gs-account.html">「AWS アカウントを作成する」</a></p></li>
<li><p><a class="reference external" href="https://docs.aws.amazon.com/ja_jp/sagemaker/latest/dg/gs-account-user.html">「IAM 管理者ユーザーおよびグループの作成」</a></p></li>
</ul>
</li>
<li><p>この記事の内容を実施すると数百円程度の課金が発生する可能性がある。課金が気になる場合は必ず削除。</p></li>
<li><p>画面や手順は2020年7月11日時点のもの。仕様変更などにより表示内容や設定値に変更が入る可能性がある。</p></li>
<li><p>チュートリアルのリージョンは「バージニア北部 (us-east-1)」を想定している。簡単のために「バージニア北部 (us-east-1)」で実施する。</p>
<ul>
<li><p>チュートリアルのソースコードには「バージニア北部」リージョンを想定するコードがあるので、これを「東京」リージョン向けに改変すれば実行は可能。</p></li>
</ul>
</li>
<li><p>ノートブックインスタンスの Python と主要なパッケージのバージョン</p></li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>名前</p></th>
<th class="head"><p>バージョン</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Python</p></td>
<td><p>3.6.10</p></td>
</tr>
<tr class="row-odd"><td><p>Numpy</p></td>
<td><p>1.18.1</p></td>
</tr>
<tr class="row-even"><td><p>Pandas</p></td>
<td><p>1.0.3</p></td>
</tr>
<tr class="row-odd"><td><p>AWS SDK for Python (Boto3)</p></td>
<td><p>1.14.16</p></td>
</tr>
<tr class="row-even"><td><p>Amazon SageMaker SDK for Python</p></td>
<td><p>1.67.1.post0</p></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p>XGBoost はビルトインアルゴリズムとして提供されている リリース 0.72 を利用する。</p></li>
</ul>
</div>
<div class="section" id="id6">
<h3>(開発) AWS マネジメントコンソールにログインする<a class="headerlink" href="#id6" title="このヘッドラインへのパーマリンク">¶</a></h3>
<ul class="simple">
<li><p>このセクションでの該当箇所は下記の赤枠です。</p></li>
</ul>
<a class="reference internal image-reference" href="../../_images/amazon_sagemaker_notebook_instance_1.png"><img alt="../../_images/amazon_sagemaker_notebook_instance_1.png" src="../../_images/amazon_sagemaker_notebook_instance_1.png" style="width: 900px;" /></a>
<p>まずは AWS マネジメントコンソールに自身の IAM ユーザでログインします。</p>
<a class="reference internal image-reference" href="../../_images/aws-management-console.png"><img alt="../../_images/aws-management-console.png" src="../../_images/aws-management-console.png" style="width: 900px;" /></a>
<p>リージョンは「バージニア北部」を利用しますので、その他のリージョンにいる場合は AWS マネジメントコンソールの右上のプルダウンメニューから移動してください。</p>
<a class="reference internal image-reference" href="../../_images/region-check.png"><img alt="../../_images/region-check.png" src="../../_images/region-check.png" style="width: 600px;" /></a>
</div>
<div class="section" id="id7">
<h3>(開発) ノートブックインスタンスを作成する<a class="headerlink" href="#id7" title="このヘッドラインへのパーマリンク">¶</a></h3>
<ul class="simple">
<li><p>このセクションでの該当箇所は下記の赤枠です。</p></li>
</ul>
<a class="reference internal image-reference" href="../../_images/amazon_sagemaker_notebook_instance_1.png"><img alt="../../_images/amazon_sagemaker_notebook_instance_1.png" src="../../_images/amazon_sagemaker_notebook_instance_1.png" style="width: 900px;" /></a>
<div class="line-block">
<div class="line">それでは、Amazon SageMaker に移動します。</div>
<div class="line">「サービスを検索する」の箇所にある検索バーに「sage」程度を入れると、「Amazon SageMaker」が登場しますので、これをクリックして移動します。</div>
</div>
<a class="reference internal image-reference" href="../../_images/search-sagemaker.png"><img alt="../../_images/search-sagemaker.png" src="../../_images/search-sagemaker.png" style="width: 900px;" /></a>
<p>下記のいずれかの画面に移動しますが、どちらでも問題ありません。</p>
<a class="reference internal image-reference" href="../../_images/sagemaker-initial.png"><img alt="../../_images/sagemaker-initial.png" src="../../_images/sagemaker-initial.png" style="width: 900px;" /></a>
<a class="reference internal image-reference" href="../../_images/sagemaker-dashboard.png"><img alt="../../_images/sagemaker-dashboard.png" src="../../_images/sagemaker-dashboard.png" style="width: 900px;" /></a>
<div class="line-block">
<div class="line">学習・推論用のコードの開発環境となる「ノートブックインスタンス」を作成していきます。</div>
<div class="line">左側の折りたたみメニューの「ノートブック」をクリックして開き、「ノートブックインスタンス」をクリックします。</div>
<div class="line">ダッシュボードにいる場合は、画面中央の「概要」の中にある「ノートブックインスタンス」をクリックしても構いません。</div>
</div>
<a class="reference internal image-reference" href="../../_images/sagemaker-dashboard-notebook.png"><img alt="../../_images/sagemaker-dashboard-notebook.png" src="../../_images/sagemaker-dashboard-notebook.png" style="width: 900px;" /></a>
<div class="line-block">
<div class="line">ノートブックインスタンスの画面に移動します。</div>
<div class="line">現在はノートブックインスタンスが存在しませんが、ここにそのリージョンに存在するノートブックインスタンスの一覧が表示されます。</div>
</div>
<a class="reference internal image-reference" href="../../_images/sagemaker-notebook-instance-initial.png"><img alt="../../_images/sagemaker-notebook-instance-initial.png" src="../../_images/sagemaker-notebook-instance-initial.png" style="width: 900px;" /></a>
<p>ノートブックインスタンスの作成画面に移動します。</p>
<a class="reference internal image-reference" href="../../_images/sagemaker-notebook-instance-create.png"><img alt="../../_images/sagemaker-notebook-instance-create.png" src="../../_images/sagemaker-notebook-instance-create.png" style="width: 900px;" /></a>
<div class="line-block">
<div class="line">ノートブックインスタンス作成時の設定項目を下記の表に示します。</div>
<div class="line">今回は簡単なチュートリアルですので、原則としてデフォルト値を設定します。各設定値の説明を記しますので、実際の業務で利用する際は要件に従って適切に設定してください。</div>
<div class="line">設定が完了したら、画面の最下部にある「ノートブックインスタンスの作成」をクリックします。</div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>大分類</p></th>
<th class="head"><p>小分類</p></th>
<th class="head"><p>設定値名</p></th>
<th class="head"><p>説明</p></th>
<th class="head"><p>デフォルト値</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>ノートブックインスタンス設定</p></td>
<td></td>
<td><p>ノートブックインスタンス名</p></td>
<td><div class="line-block">
<div class="line">ノートブックインスタンスの名前を設定する。</div>
<div class="line">最大 63 文字まで設定可能。英数字もしくはハイフン (-) の利用が可能。</div>
<div class="line">1つのAWS リージョンのアカウント内で一意である必要がある。</div>
</div>
</td>
<td><div class="line-block">
<div class="line">(空白)</div>
<div class="line">今回は「mynotebook」と設定</div>
</div>
</td>
</tr>
<tr class="row-odd"><td></td>
<td></td>
<td><p>ノートブックインスタンスのタイプ</p></td>
<td><div class="line-block">
<div class="line">ノートブックインスタンスのタイプを設定する。</div>
<div class="line">まずは「ml.t2.medium」など小さいインスタンスで試した方が良い。</div>
<div class="line">CPU やメモリなどのリソース不足が発生した場合にスケールアップもしくは不足するリソースに応じたインスタンスタイプを選択する。</div>
<div class="line">(例) CPUを重点的に増やしたい：コンピューティング最適化 (ml.c5.large など)、 メモリを重点的に増やしたい：メモリの最適化 (ml.r5.large など)</div>
<div class="line"><a class="reference external" href="https://aws.amazon.com/jp/sagemaker/pricing/instance-types/">「Amazon SageMaker ML インスタンスタイプ」</a></div>
<div class="line"><a class="reference external" href="https://aws.amazon.com/jp/sagemaker/pricing/">「Amazon SageMaker の料金」</a></div>
</div>
</td>
<td><p>ml.t2.medium</p></td>
</tr>
<tr class="row-even"><td></td>
<td></td>
<td><p>Elastic Inference</p></td>
<td><div class="line-block">
<div class="line">GPU リソースをアタッチする。ディープラーニングフレームワーク TensorFlow、 Apache MXNet、PyTorch でサポートされている。</div>
<div class="line"><a class="reference external" href="https://docs.aws.amazon.com/ja_jp/sagemaker/latest/dg/ei.html">「Amazon SageMaker Elastic Inference (EI) を使用する」</a></div>
</div>
</td>
<td><p>なし</p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>追加設定</p></td>
<td><p>ライフサイクル設定</p></td>
<td><p>ノートブックインスタンスの作成時にスクリプトを実行して、ノートブックインスタンスをカスタマイズする。</p></td>
<td><p>設定値なし</p></td>
</tr>
<tr class="row-even"><td></td>
<td></td>
<td><p>ボリュームサイズ (GB 単位)</p></td>
<td><div class="line-block">
<div class="line">ノートブックインスタンスにアタッチする EBS ボリューム (ディスク) のサイズ。</div>
<div class="line">ボリュームサイズは 5 GB - 16 TB の範囲で設定可能。</div>
</div>
</td>
<td><p>5</p></td>
</tr>
<tr class="row-odd"><td><p>アクセス許可と暗号化</p></td>
<td></td>
<td><p>IAM ロール</p></td>
<td><div class="line-block">
<div class="line">ノートブックインスタンスに付与する AWS リソースの操作権限を IAM ロールとして設定する。</div>
<div class="line">AmazonSageMakerFullAccess を付与する場合、<a class="reference external" href="https://docs.aws.amazon.com/ja_jp/sagemaker/latest/dg/sagemaker-roles.html#sagemaker-roles-amazonsagemakerfullaccess-policy">「AmazonSageMakerFullAccess ポリシー」</a> に記載されている操作権限が付与される。</div>
</div>
</td>
<td><p>新しい IAM ロールの作成</p></td>
</tr>
<tr class="row-even"><td></td>
<td></td>
<td><p>ルートアクセス - オプション</p></td>
<td></td>
<td><p>有効化 - ノートブックへのルートアクセス権をユーザーに付与する</p></td>
</tr>
<tr class="row-odd"><td></td>
<td></td>
<td><p>暗号化キー - オプション</p></td>
<td><p>ノートブックインスタンスにアタッチする EBS ボリューム (ディスク) の Amazon KMS の暗号鍵を設定する。</p></td>
<td><p>カスタム暗号化なし</p></td>
</tr>
<tr class="row-even"><td><p>ネットワーク - オプション</p></td>
<td></td>
<td><p>VPC - オプション</p></td>
<td></td>
<td><p>非 VPC</p></td>
</tr>
<tr class="row-odd"><td><p>Git リポジトリ - オプション</p></td>
<td><p>デフォルトのリポジトリ</p></td>
<td><p>リポジトリ</p></td>
<td><div class="line-block">
<div class="line">ノートブックインスタンスの作成時に自動で Git リポジトリをクローンする。</div>
<div class="line">例えば、学習・推論用コードが格納された Git リポジトリやアプリのコードが格納されたリポジトリを自動でクローンし、その分の手間が省ける。</div>
<div class="line">デフォルトのリポジトリを1つ、追加のリポジトリを最大3つ設定可能。</div>
</div>
</td>
<td><p>なし</p></td>
</tr>
<tr class="row-even"><td><p>タグ - オプション</p></td>
<td></td>
<td><p>キー、値</p></td>
<td><div class="line-block">
<div class="line">キーバリュー形式で値を設定する。</div>
<div class="line">(例) Name タグ (Name: <em>&lt;notebook_instance_name&gt;</em>)、環境タグ (Environment: Production)</div>
</div>
</td>
<td><p>(空白)</p></td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line">ノートブックインスタンスに付与する IAM ロールに関して補足します。</div>
<div class="line">IAM ロールは AWS のリソースに操作権限を与えるために利用します。</div>
<div class="line">例えば、学習用データの取得のためにノートブックインスタンスから Amazon S3 のバケットにアクセスが必要となります。</div>
<div class="line">IAM ユーザに紐づく認証情報として「アクセスキー ID」と「シークレットキー」がありますが、これをコードにハードコーディングすることはアンチパターンとなります。</div>
<div class="line">IAM ロールに操作権限を定義してノートブックインスタンスに付与することで、具体的な認証情報を記述せずに操作権限を付与することができます。</div>
</div>
<ul class="simple">
<li><p>(備忘) 図を入れる。</p></li>
</ul>
<div class="line-block">
<div class="line">今回新規作成した IAM ロールは「AmazonSageMakerFullAccess ポリシー」が操作権限として与えられています。</div>
<div class="line">特に、下記の条件に当てはまる Amazon S3 のバケットとオブジェクトの操作権限が与えられる点に注意してください。</div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>条件</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>指定する S3 バケット - オプション</p></td>
<td><div class="line-block">
<div class="line">本項目以外の条件に当てはまらない S3 バケットに対するアクセスを許可する。オプション項目であり、これを設定しないことも可能。</div>
<div class="line">- <strong>任意の S3 バケット</strong></div>
<div class="line">(例) my-s3-bucket</div>
<div class="line">- <strong>特定の S3 バケット</strong></div>
<div class="line">(例) my-s3-bucket-1, my-s3-bucket-2</div>
<div class="line">- <strong>なし</strong></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p>名前に「sagemaker」が含まれる任意の S3 バケット</p></td>
<td><div class="line-block">
<div class="line">下記のように S3 バケット名に「sagemaker」を含む S3 バケットにはアクセスが可能。</div>
<div class="line">(例) <strong>アクセス可能</strong> : my-sagemaker-s3-bucket、<strong>アクセス不可能</strong> : my-s3-bucket</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p>名前に「sagemaker」が含まれる任意の S3 オブジェクト</p></td>
<td><div class="line-block">
<div class="line">下記のように S3 バケットに格納されているオブジェクト (ファイル) 名に 「sagemaker」を含むオブジェクトにはアクセスが可能。</div>
<div class="line">(例) <strong>アクセス可能</strong> : my-sagemaker-object.csv、<strong>アクセス不可能</strong> : my-object.csv</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p>タグ「sagemaker」と値「true」が含まれる任意の S3 オブジェクトにはアクセスが可能。</p></td>
<td><div class="line-block">
<div class="line">キーが「sagemaker」、値が「true」と設定されたオブジェクトにはアクセスが可能。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p>SageMaker へのアクセスを許可するバケットポリシーを持つ S3 バケット</p></td>
<td><p>条件に記載されている通り、バケットポリシーにて Amazon SageMaker のアクセスが許可された S3 バケットにはアクセスが可能。</p></td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line">設定値に問題がなければ画面が切り替わり、「成功! ノートブックインスタンスが作成されています。」と表示されます。</div>
<div class="line">数分間待って、「ステータス」が「<strong>Pending</strong>」から「<strong>InService</strong>」に変わると、ノートブックインスタンスの作成が完了です。</div>
</div>
<a class="reference internal image-reference" href="../../_images/sagemaker-notebook-instance-create-pending.png"><img alt="../../_images/sagemaker-notebook-instance-create-pending.png" src="../../_images/sagemaker-notebook-instance-create-pending.png" style="width: 900px;" /></a>
<a class="reference internal image-reference" href="../../_images/sagemaker-notebook-instance-create-inservice.png"><img alt="../../_images/sagemaker-notebook-instance-create-inservice.png" src="../../_images/sagemaker-notebook-instance-create-inservice.png" style="width: 900px;" /></a>
</div>
<div class="section" id="id9">
<h3>(開発) ノートブックを起動する<a class="headerlink" href="#id9" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="line-block">
<div class="line">ノートブックインスタンスの作成まで完了したので、ノートブックを起動します。</div>
</div>
<ul class="simple">
<li><p>(備忘) このセクションでの該当箇所は下記の赤枠です。</p></li>
</ul>
<a class="reference internal image-reference" href="../../_images/amazon_sagemaker_notebook_instance_1.png"><img alt="../../_images/amazon_sagemaker_notebook_instance_1.png" src="../../_images/amazon_sagemaker_notebook_instance_1.png" style="width: 900px;" /></a>
<div class="line-block">
<div class="line">Amazon SageMaker のノートブックインスタンスでは、Jupyter Notebook もしくは JupyterLab が利用できます。</div>
<div class="line">これらがプリインストールされた状態でノートブックインスタンスが作成されており、利用者側でインストールは必要ありません。</div>
</div>
<div class="line-block">
<div class="line">Jupyter Notebook、JupyterLab は <a class="reference external" href="https://jupyter.org/index.html">Project Jupyter</a> と呼ばれる非営利の OSS プロジェクトにより管理されているプログラミングのツールです。</div>
<div class="line">Python をはじめとして、R や Spark など様々な言語で利用することができます。</div>
<div class="line">コードを「セル」と呼ばれるブロックに記載して、少しずつ確認しながら実行することができます。</div>
<div class="line">また、マークダウンでテキストや画像、数式なども記載することもできますので、従来のテキストベースのソースコードと比較すると背景や設計根拠などを詳細に残すことができます。</div>
</div>
<ul class="simple">
<li><p>(備忘) サンプルか何かのノートブックの画像を入れる。</p></li>
</ul>
<div class="line-block">
<div class="line">JupyterLab は Jupyter Notebook の後継となるノートブックです。</div>
<div class="line">このチュートリアルを実施範囲ではどちらを選んでも問題ありません。</div>
<div class="line">AWS のチュートリアルは Jupyter Notebook を利用していますので、こちらの記事では「JupyterLab」を利用して進めたいと思います。</div>
</div>
<div class="line-block">
<div class="line">「アクション」の「JupyterLab を開く」をクリックします。</div>
<div class="line">なお、前者をクリックすると従来からの Jupyter notebook が起動し、後者をクリックすると JupyterLab が起動します。</div>
</div>
<a class="reference internal image-reference" href="../../_images/sagemaker-notebook-launch.png"><img alt="../../_images/sagemaker-notebook-launch.png" src="../../_images/sagemaker-notebook-launch.png" style="width: 900px;" /></a>
<div class="line-block">
<div class="line">JupyterLab を起動すると、下記のような「Launcher」タブが表示されます。</div>
<div class="line">Python を中心に様々な実行環境が用意されています。</div>
<div class="line">このチュートリアルでは、Python 3 の実行環境があれば良いので、「Notebook」の配下にある「conda_python3」をダブルクリックします。</div>
</div>
<a class="reference internal image-reference" href="../../_images/sagemaker-jupyterlab-launcher.png"><img alt="../../_images/sagemaker-jupyterlab-launcher.png" src="../../_images/sagemaker-jupyterlab-launcher.png" style="width: 900px;" /></a>
<div class="line-block">
<div class="line">すると、「Untitled.ipynb」というタブに切り替わり、左側のメニューに同名のファイルが表示されます。</div>
<div class="line">これは Jupyter Notebook のファイルとなります。</div>
<div class="line">今回はこの状態のまま進みますが、左側のメニューを右クリックして、「Rename」を選択することによりファイル名を変更することも可能です。</div>
</div>
<a class="reference internal image-reference" href="../../_images/sagemaker-jupyterlab-python3-notebook.png"><img alt="../../_images/sagemaker-jupyterlab-python3-notebook.png" src="../../_images/sagemaker-jupyterlab-python3-notebook.png" style="width: 900px;" /></a>
<div class="section" id="id10">
<h4>実行するコード<a class="headerlink" href="#id10" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>下記のコードをセルにコピー＆ペーストして実行してください。</p>
<div class="line-block">
<div class="line">グレーの部分を「セル」と呼び、ここにコードを記述していきます。</div>
<div class="line">下記のコードをコピー＆ペーストして、「Run」を押下するか、「Shift」+「Enter」で実行できます。</div>
<div class="line">この後もいくつかコードを示しますが、同様の方法で実行してください。</div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># import libraries</span>
<span class="kn">import</span> <span class="nn">boto3</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">math</span><span class="o">,</span> <span class="nn">json</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sagemaker</span><span class="o">,</span> <span class="nn">urllib.request</span>
<span class="kn">from</span> <span class="nn">sagemaker</span> <span class="kn">import</span> <span class="n">get_execution_role</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">gmtime</span><span class="p">,</span> <span class="n">strftime</span>
<span class="kn">from</span> <span class="nn">sagemaker.predictor</span> <span class="kn">import</span> <span class="n">csv_serializer</span>

<span class="c1"># Define IAM role</span>
<span class="n">role</span> <span class="o">=</span> <span class="n">get_execution_role</span><span class="p">()</span>
<span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;sagemaker/DEMO-xgboost-dm&#39;</span>
<span class="n">containers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;us-west-2&#39;</span><span class="p">:</span> <span class="s1">&#39;433757028032.dkr.ecr.us-west-2.amazonaws.com/xgboost:latest&#39;</span><span class="p">,</span>
              <span class="s1">&#39;us-east-1&#39;</span><span class="p">:</span> <span class="s1">&#39;811284229777.dkr.ecr.us-east-1.amazonaws.com/xgboost:latest&#39;</span><span class="p">,</span>
              <span class="s1">&#39;us-east-2&#39;</span><span class="p">:</span> <span class="s1">&#39;825641698319.dkr.ecr.us-east-2.amazonaws.com/xgboost:latest&#39;</span><span class="p">,</span>
              <span class="s1">&#39;eu-west-1&#39;</span><span class="p">:</span> <span class="s1">&#39;685385470294.dkr.ecr.eu-west-1.amazonaws.com/xgboost:latest&#39;</span><span class="p">}</span> <span class="c1"># each region has its XGBoost container</span>
<span class="n">my_region</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span><span class="o">.</span><span class="n">region_name</span> <span class="c1"># set the region of the instance</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;Success - the MySageMakerInstance is in the &quot;</span> <span class="o">+</span> <span class="n">my_region</span> <span class="o">+</span> <span class="s2">&quot; region. You will use the &quot;</span> <span class="o">+</span> <span class="n">containers</span><span class="p">[</span><span class="n">my_region</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; container for your SageMaker endpoint.&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">セルの下側に下記のメッセージが出力されれば成功であり、一旦ノートブックインスタンスとノートブックが正常に作成できたと考えて良いと思います。</div>
<div class="line"><em>Success - the MySageMakerInstance is in the us-east-1 region. You will use the 811284229777.dkr.ecr.us-east-1.amazonaws.com/xgboost:latest container for your SageMaker endpoint.</em></div>
</div>
</div>
<div class="section" id="id11">
<h4>コードの解説<a class="headerlink" href="#id11" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>ここでは「<cite># import libraries</cite>」と「<cite># Define IAM role</cite>」から始まる大きく2つの処理に分けられます。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># import libraries</span>
<span class="kn">import</span> <span class="nn">boto3</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">math</span><span class="o">,</span> <span class="nn">json</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sagemaker</span><span class="o">,</span> <span class="nn">urllib.request</span>
<span class="kn">from</span> <span class="nn">sagemaker</span> <span class="kn">import</span> <span class="n">get_execution_role</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="c1"># (以下、省略)</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">「<cite># import libraries</cite>」から始まる処理では、チュートリアルの実行に必要なライブラリ (モジュール) の読み込み (インポート) を行っています。</div>
<div class="line">Python でよく利用される「Numpy」や「Pandas」に加えて、「Boto3」と呼ばれる 「<a class="reference external" href="https://aws.amazon.com/jp/sdk-for-python/">AWS SDK for Python</a>」、その名の通りで Amazon SageMaker の Python 向け SDK である「<a class="reference external" href="https://sagemaker.readthedocs.io/en/stable/">Amazon SageMaker SDK for Python</a>」を読み込んでいます。</div>
<div class="line">Matplotlib など利用しないものも一部含まれますが、ここでは一旦無視しましょう。</div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define IAM role</span>
<span class="n">role</span> <span class="o">=</span> <span class="n">get_execution_role</span><span class="p">()</span>
<span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;sagemaker/DEMO-xgboost-dm&#39;</span>
<span class="n">containers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;us-west-2&#39;</span><span class="p">:</span> <span class="s1">&#39;433757028032.dkr.ecr.us-west-2.amazonaws.com/xgboost:latest&#39;</span><span class="p">,</span>
              <span class="s1">&#39;us-east-1&#39;</span><span class="p">:</span> <span class="s1">&#39;811284229777.dkr.ecr.us-east-1.amazonaws.com/xgboost:latest&#39;</span><span class="p">,</span>
              <span class="s1">&#39;us-east-2&#39;</span><span class="p">:</span> <span class="s1">&#39;825641698319.dkr.ecr.us-east-2.amazonaws.com/xgboost:latest&#39;</span><span class="p">,</span>
              <span class="s1">&#39;eu-west-1&#39;</span><span class="p">:</span> <span class="s1">&#39;685385470294.dkr.ecr.eu-west-1.amazonaws.com/xgboost:latest&#39;</span><span class="p">}</span> <span class="c1"># each region has its XGBoost container</span>
<span class="n">my_region</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span><span class="o">.</span><span class="n">region_name</span> <span class="c1"># set the region of the instance</span>
</pre></div>
</div>
<p>「<cite># Define IAM role</cite>」から始まる処理では、主に下記を実行しています。</p>
<div class="line-block">
<div class="line">1. ノートブックインスタンスにアタッチした IAM ロールの実行権限の取得</div>
<div class="line">2. S3 バケットのプレフィックスの設定</div>
<div class="line">3. 組み込みアルゴリズム XGBoost のコンテナイメージの ECR レジストリのパスの設定</div>
<div class="line">4. リージョンの設定</div>
</div>
<p>特に、1 と 3 の処理について見ていきます。</p>
<div class="section" id="id12">
<h5>1. ノートブックインスタンスにアタッチした IAM ロールの実行権限の取得<a class="headerlink" href="#id12" title="このヘッドラインへのパーマリンク">¶</a></h5>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">role</span> <span class="o">=</span> <span class="n">get_execution_role</span><span class="p">()</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">ノートブックインスタンスの実行ロールの ARN を取得して、その実行ロールを使用して操作を行います。</div>
<div class="line">ここでいう「実行ロール」とは、ノートブックインスタンス作成時に新規作成した IAM ロールであり、「AmazonSageMakerFullAccess ポリシー」が操作権限として与えられています。</div>
<div class="line">詳細に知りたい方は、「<a class="reference external" href="https://docs.aws.amazon.com/ja_jp/sagemaker/latest/dg/automatic-model-tuning-ex-role.html">Amazon SageMaker の実行ロールを取得する</a>」「<a class="reference external" href="https://sagemaker.readthedocs.io/en/stable/api/utility/session.html#sagemaker.session.get_execution_role">sagemaker.session.get_execution_role(sagemaker_session=None)</a>」を参照してください。</div>
</div>
</div>
<div class="section" id="xgboost-ecr">
<h5>3. 組み込みアルゴリズム XGBoost のコンテナイメージの ECR レジストリのパスの設定<a class="headerlink" href="#xgboost-ecr" title="このヘッドラインへのパーマリンク">¶</a></h5>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">containers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;us-west-2&#39;</span><span class="p">:</span> <span class="s1">&#39;433757028032.dkr.ecr.us-west-2.amazonaws.com/xgboost:latest&#39;</span><span class="p">,</span>
              <span class="s1">&#39;us-east-1&#39;</span><span class="p">:</span> <span class="s1">&#39;811284229777.dkr.ecr.us-east-1.amazonaws.com/xgboost:latest&#39;</span><span class="p">,</span>
              <span class="s1">&#39;us-east-2&#39;</span><span class="p">:</span> <span class="s1">&#39;825641698319.dkr.ecr.us-east-2.amazonaws.com/xgboost:latest&#39;</span><span class="p">,</span>
              <span class="s1">&#39;eu-west-1&#39;</span><span class="p">:</span> <span class="s1">&#39;685385470294.dkr.ecr.eu-west-1.amazonaws.com/xgboost:latest&#39;</span><span class="p">}</span> <span class="c1"># each region has its XGBoost container</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">前回説明したように、Amazon SageMaker では Amazon ECR から学習用コンテナイメージをダウンロードし、学習用インスタンス上でコンテナを起動して学習を行います。</div>
<div class="line">「組み込みアルゴリズムによる学習を行う」とは、すなわち、「AWS が管理する学習用コンテナイメージを利用して学習を行う」ということです。</div>
</div>
<div class="line-block">
<div class="line">上記のコードは AWS が管理する Amazon ECR のレジストリから「XGBoost リリース 0.72 のコンテナイメージで最新 (latest) 」取得するための設定です。</div>
<div class="line">AWS が管理する Amazon ECR のレジストリはリージョンごとに用意されており、今回は「バージニア北部 (us-east-1)」ですので、「<cite>811284229777.dkr.ecr.us-east-1.amazonaws.com/xgboost:latest</cite>」からコンテナイメージを取得します。</div>
<div class="line">「東京 (ap-northeast-1)」で利用する場合は、「<cite>'ap-northeast-1': '501404015308.dkr.ecr.ap-northeast-1.amazonaws.com'</cite>」を追加するなどコードの改変が必要です。</div>
</div>
<div class="line-block">
<div class="line">また、今回は「XGBoost リリース 0.72」を利用していますが、より新しい「XGBoost リリース 0.90」もリリースされています。</div>
<div class="line">リリース 0.72 と 0.90 とではレジストリのパスが異なりますので、ご注意ください。</div>
<div class="line">詳細に知りたい方は、「<a class="reference external" href="https://docs.aws.amazon.com/ja_jp/sagemaker/latest/dg/sagemaker-algo-docker-registry-paths.html">組み込みアルゴリズムの共通パラメータ</a>」を参照してください。</div>
<div class="line">今回は組み込みアルゴリズムの中から XGBoost を利用していますが、その他のアルゴリズムについても記載されていますので、応用する際に参照して適切に変更してください。</div>
</div>
</div>
</div>
</div>
<div class="section" id="s3">
<h3>(開発) 学習・推論に利用するデータを格納するための S3 バケットを作成する<a class="headerlink" href="#s3" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="line-block">
<div class="line">前のセクションで開発環境であるノートブックインスタンスの作成が完了しました。</div>
<div class="line">ここでは、学習・推論に利用するデータを格納するための S3 バケットを作成します。</div>
<div class="line">作業は引き続き、JupyterLab で行います。</div>
</div>
<ul class="simple">
<li><p>(備忘) このセクションでの該当箇所は下記の赤枠です。</p></li>
</ul>
<a class="reference internal image-reference" href="../../_images/amazon_sagemaker_notebook_instance_1.png"><img alt="../../_images/amazon_sagemaker_notebook_instance_1.png" src="../../_images/amazon_sagemaker_notebook_instance_1.png" style="width: 900px;" /></a>
<div class="section" id="id15">
<h4>実行するコード<a class="headerlink" href="#id15" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>下記のコードをセルにコピー＆ペーストして実行してください。</p>
<div class="line-block">
<div class="line">下記のコードをセルにコピー＆ペーストした後に、必ず ** <cite>bucket_name</cite> の <cite>your-s3-bucket-name</cite> の箇所を変更してから** 実行してください。</div>
<div class="line">S3 バケット名は世界で唯一の値にする必要がありますので、名前が重複するとエラーとなります。</div>
<div class="line">S3 バケット名には、「AWS アカウント ID (12桁の数字)」を含めるなどすると重複しづらいと思います。検証目的であれば「日付」を入れても良いと思います。</div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">bucket_name</span> <span class="o">=</span> <span class="s1">&#39;your-s3-bucket-name&#39;</span> <span class="c1"># &lt;--- CHANGE THIS VARIABLE TO A UNIQUE NAME FOR YOUR BUCKET</span>
<span class="n">s3</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s1">&#39;s3&#39;</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="k">if</span>  <span class="n">my_region</span> <span class="o">==</span> <span class="s1">&#39;us-east-1&#39;</span><span class="p">:</span>
      <span class="n">s3</span><span class="o">.</span><span class="n">create_bucket</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">bucket_name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">s3</span><span class="o">.</span><span class="n">create_bucket</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">CreateBucketConfiguration</span><span class="o">=</span><span class="p">{</span> <span class="s1">&#39;LocationConstraint&#39;</span><span class="p">:</span> <span class="n">my_region</span> <span class="p">})</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;S3 bucket created successfully&#39;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;S3 error: &#39;</span><span class="p">,</span><span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id16">
<h4>コードの解説<a class="headerlink" href="#id16" title="このヘッドラインへのパーマリンク">¶</a></h4>
<div class="line-block">
<div class="line">チュートリアルでは AWS SDK for Python (Boto3) を利用してノートブックから S3 バケットを作成する方法が示されています。</div>
<div class="line">AWS マネジメントコンソールを利用しても同等の作業ができますが、ノートブックで作成した方が後々の開発効率を考えても好ましいと考えられます。</div>
<div class="line">作業の慣れの問題でもあると考えられるので、これを機に習得した方が良いと思います。</div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">s3</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s1">&#39;s3&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">AWS SDK for Python (Boto3) では、 AWS のリソースを操作する方法に「Resources」と「Clients」の2種類があります。</div>
<div class="line">このチュートリアルでは、抽象度の高い「Resources」の方の API を使って S3 バケットを作成しています。</div>
</div>
<ul class="simple">
<li><p><a class="reference external" href="https://boto3.amazonaws.com/v1/documentation/api/latest/guide/resources.html">Resources</a> : 高レベルのオブジェクト指向インターフェース。Clients と比べて抽象度が高い。</p></li>
<li><p><a class="reference external" href="https://boto3.amazonaws.com/v1/documentation/api/latest/guide/clients.html">Clients</a>: 低レベルのサービス接続。メソッドはサービス API とほぼ1：1で対応し、すべてのサービスの操作がサポートされる。</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span>  <span class="n">my_region</span> <span class="o">==</span> <span class="s1">&#39;us-east-1&#39;</span><span class="p">:</span>
  <span class="n">s3</span><span class="o">.</span><span class="n">create_bucket</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">bucket_name</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
  <span class="n">s3</span><span class="o">.</span><span class="n">create_bucket</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">CreateBucketConfiguration</span><span class="o">=</span><span class="p">{</span> <span class="s1">&#39;LocationConstraint&#39;</span><span class="p">:</span> <span class="n">my_region</span> <span class="p">})</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><a class="reference external" href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/s3.html#S3.Client.create_bucket">create_bucket</a> メソッドの <cite>CreateBucketConfiguration</cite> という引数では S3 バケットを作成するリージョンを指定します。</div>
<div class="line">これが省略された場合、作成するリージョンが「バージニア北部 (us-east-1)」となるため、<cite>my_region</cite> の値によって条件分岐をしています。</div>
</div>
</div>
</div>
<div class="section" id="id17">
<h3>(開発) 学習・推論に利用するデータを準備する<a class="headerlink" href="#id17" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="line-block">
<div class="line">前のセクションで学習・推論用のデータを格納するための S3 バケットの作成が完了しました。</div>
<div class="line">ここでは、インターネット上で公開されているデータをノートブックインスタンスのローカルディスク上にダウンロードして簡単な前処理を行います。</div>
<div class="line">作業は引き続き、JupyterLab で行います。</div>
</div>
<ul class="simple">
<li><p>(備忘) このセクションでの該当箇所は下記の赤枠です。</p></li>
</ul>
<a class="reference internal image-reference" href="../../_images/amazon_sagemaker_notebook_instance_1.png"><img alt="../../_images/amazon_sagemaker_notebook_instance_1.png" src="../../_images/amazon_sagemaker_notebook_instance_1.png" style="width: 900px;" /></a>
<div class="section" id="id18">
<h4>実行するコード<a class="headerlink" href="#id18" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>下記のコードをセルにコピー＆ペーストして実行してください。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
  <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span> <span class="p">(</span><span class="s2">&quot;https://d1.awsstatic.com/tmt/build-train-deploy-machine-learning-model-sagemaker/bank_clean.27f01fbbdf43271788427f3682996ae29ceca05d.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;bank_clean.csv&quot;</span><span class="p">)</span>
  <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Success: downloaded bank_clean.csv.&#39;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
  <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Data load error: &#39;</span><span class="p">,</span><span class="n">e</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
  <span class="n">model_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;./bank_clean.csv&#39;</span><span class="p">,</span><span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
  <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Success: Data loaded into dataframe.&#39;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Data load error: &#39;</span><span class="p">,</span><span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
<p>上記の実行後に、下記のコードもセルにコピー＆ペーストして実行してください。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">train_data</span><span class="p">,</span> <span class="n">test_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">model_data</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1729</span><span class="p">),</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mf">0.7</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_data</span><span class="p">))])</span>
<span class="k">print</span><span class="p">(</span><span class="n">train_data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">test_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id19">
<h4>コードの解説<a class="headerlink" href="#id19" title="このヘッドラインへのパーマリンク">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span> <span class="p">(</span><span class="s2">&quot;https://d1.awsstatic.com/tmt/build-train-deploy-machine-learning-model-sagemaker/bank_clean.27f01fbbdf43271788427f3682996ae29ceca05d.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;bank_clean.csv&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><a class="reference external" href="https://docs.python.org/ja/3.6/library/urllib.request.html#urllib.request.urlretrieve">urllib.request.urlretrieve</a> メソッドは、引数に指定した URL からファイルをローカルにダウンロードします。</div>
<div class="line">引数に示した URL は ドメイン名から AWS の静的ファイルを配布するための CDN サービスである Amazon CloudFront もしくは Amazon S3 と思われます。</div>
<div class="line">ここからノートブックインスタンスのローカルディスク上に、学習や推論に利用するデータである「Bank Marketing Data Set」をダウンロードしています。</div>
</div>
<div class="line-block">
<div class="line">AWS が配布しているデータは、チュートリアルを進めやすいように前処理の実施済のデータです。</div>
<div class="line">UCI の Machine Learning Repository で公開されているデータをダウンロードして利用する場合は、そのままの状態では利用できず、機械学習で利用できるようにデータの前処理が必要となりますのでご注意ください。</div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;./bank_clean.csv&#39;</span><span class="p">,</span><span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>Pandas の <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.read_csv.html">read_csv</a> メソッドを使って、CSV 形式の「Bank Marketing Data Set」を DataFrame に読み込んでいます。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">train_data</span><span class="p">,</span> <span class="n">test_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">model_data</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1729</span><span class="p">),</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mf">0.7</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_data</span><span class="p">))])</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">Numpy の split メソッドを使って、DataFrame として読み込んだデータ (model_data) を学習データ (train_data) とテストデータ (test_data) を 7:3 の割合で分割しています。</div>
<div class="line">更に、Pandas の <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.sample.html">sample</a> メソッドを使ってランダムにデータを選択することでデータの順序性を排除しています。</div>
</div>
</div>
</div>
<div class="section" id="id20">
<h3>(開発) 学習用のコードを開発する<a class="headerlink" href="#id20" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="line-block">
<div class="line">データの準備まで完了しましたので、ここからは学習用のコードを開発していきます。</div>
<div class="line">今回は Amazon SageMaker に`組み込みアルゴリズム &lt;<a class="reference external" href="https://docs.aws.amazon.com/ja_jp/sagemaker/latest/dg/algos.html">https://docs.aws.amazon.com/ja_jp/sagemaker/latest/dg/algos.html</a>&gt;`_ として用意されている「<a class="reference external" href="https://docs.aws.amazon.com/ja_jp/sagemaker/latest/dg/xgboost.html">XGBoost</a>」と呼ばれる機械学習アルゴリズムを利用します。</div>
</div>
<div class="line-block">
<div class="line">組み込みアルゴリズムとして提供されている機械学習アルゴリズムは、コンテナイメージとして予め Amazon ECR のレジストリに準備されています。</div>
<div class="line">利用者は機械学習アルゴリズムを実装する必要はありません。</div>
<div class="line">利用したい機械学習アルゴリズムのコンテナイメージをダウンロードしてコンテナを起動し、学習データを渡すだけで利用することができます。</div>
</div>
<ul class="simple">
<li><p>(備忘) このセクションでの該当箇所は下記の赤枠です。</p></li>
</ul>
<a class="reference internal image-reference" href="../../_images/amazon_sagemaker_notebook_instance_1.png"><img alt="../../_images/amazon_sagemaker_notebook_instance_1.png" src="../../_images/amazon_sagemaker_notebook_instance_1.png" style="width: 900px;" /></a>
<div class="line-block">
<div class="line">XGBoost を利用するための準備として、学習用データの並べ替えと Estimator と呼ばれる Amazon SageMaker の学習の設定を行います。</div>
<div class="line">下記のコードをセルにコピー＆ペーストして実行してください。</div>
</div>
<div class="section" id="id21">
<h4>実行するコード<a class="headerlink" href="#id21" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>下記のコードをセルにコピー＆ペーストして実行してください。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">train_data</span><span class="p">[</span><span class="s1">&#39;y_yes&#39;</span><span class="p">],</span> <span class="n">train_data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;y_no&#39;</span><span class="p">,</span> <span class="s1">&#39;y_yes&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;train.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s1">&#39;s3&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Bucket</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">)</span><span class="o">.</span><span class="n">Object</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="s1">&#39;train/train.csv&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span><span class="s1">&#39;train.csv&#39;</span><span class="p">)</span>
<span class="n">s3_input_train</span> <span class="o">=</span> <span class="n">sagemaker</span><span class="o">.</span><span class="n">s3_input</span><span class="p">(</span><span class="n">s3_data</span><span class="o">=</span><span class="s1">&#39;s3://{}/{}/train&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">prefix</span><span class="p">),</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;csv&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>上記の実行後に、下記のコードもセルにコピー＆ペーストして実行してください。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sess</span> <span class="o">=</span> <span class="n">sagemaker</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
<span class="n">xgb</span> <span class="o">=</span> <span class="n">sagemaker</span><span class="o">.</span><span class="n">estimator</span><span class="o">.</span><span class="n">Estimator</span><span class="p">(</span><span class="n">containers</span><span class="p">[</span><span class="n">my_region</span><span class="p">],</span><span class="n">role</span><span class="p">,</span> <span class="n">train_instance_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">train_instance_type</span><span class="o">=</span><span class="s1">&#39;ml.m4.xlarge&#39;</span><span class="p">,</span><span class="n">output_path</span><span class="o">=</span><span class="s1">&#39;s3://{}/{}/output&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">prefix</span><span class="p">),</span><span class="n">sagemaker_session</span><span class="o">=</span><span class="n">sess</span><span class="p">)</span>
<span class="n">xgb</span><span class="o">.</span><span class="n">set_hyperparameters</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">eta</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span><span class="n">gamma</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">min_child_weight</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span><span class="n">subsample</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">silent</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">objective</span><span class="o">=</span><span class="s1">&#39;binary:logistic&#39;</span><span class="p">,</span><span class="n">num_round</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id22">
<h4>コードの解説<a class="headerlink" href="#id22" title="このヘッドラインへのパーマリンク">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">train_data</span><span class="p">[</span><span class="s1">&#39;y_yes&#39;</span><span class="p">],</span> <span class="n">train_data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;y_no&#39;</span><span class="p">,</span> <span class="s1">&#39;y_yes&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;train.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">組み込みアルゴリズムの XGBoost は、学習データを表形式でデータを与える必要があります。</div>
<div class="line">学習データの1列目を目的変数に、2列目以降を説明変数 (特徴量) とする必要があります。</div>
<div class="line">今回の場合、目的変数は「キャンペーンの結果、顧客が預金証書 (CD) を申し込んだか否か」、説明変数は年齢や職業などの「顧客の属性情報」となります。</div>
</div>
<div class="line-block">
<div class="line">加工前の状態では、目的変数の列が一番後ろに存在しますることに加えて、「<cite>y_yes</cite> (申し込んだ)」だけでなく、「<cite>y_no</cite> (申し込まなかった)」も存在します。</div>
<div class="line">Pandas の <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.concat.html">concat</a> を使って、「<cite>y_yes</cite>」を切り出して1列目に、後方に存在する「y_yes」「y_no」を削除 (drop) した表を結合して新たな表を作成しています。</div>
<div class="line">組み込みアルゴリズムの XGBoost は、学習データの形式として CSV 形式もしくは libsvm 形式をサポートしていますので、ここでは CSV 形式に変換しています。</div>
</div>
<ul class="simple">
<li><p>(備忘) 変換前後の DF を示す。</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
  <span class="n">boto3</span>
    <span class="o">.</span><span class="n">Session</span><span class="p">()</span>
    <span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s1">&#39;s3&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">Bucket</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">)</span>
    <span class="o">.</span><span class="n">Object</span><span class="p">(</span>
      <span class="n">os</span>
        <span class="o">.</span><span class="n">path</span>
        <span class="o">.</span><span class="n">join</span><span class="p">(</span>
          <span class="n">prefix</span><span class="p">,</span>
          <span class="s1">&#39;train/train.csv&#39;</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">upload_file</span><span class="p">(</span><span class="s1">&#39;train.csv&#39;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">メソッドチェーンで書かれていて見通しが悪いので、改行してみます。</div>
<div class="line">要するに、ここでやりたいことは「学習データを S3 バケットにアップロードする」ことです。</div>
</div>
<div class="line-block">
<div class="line"><a class="reference external" href="https://boto3.amazonaws.com/v1/documentation/api/latest/guide/session.html">Session</a> クラスは、AWS のリソースを操作するために認証情報を環境変数やプロファイルから取得して設定します。</div>
<div class="line">その後の処理はメソッド名から推測できると思いますが、<cite>resource</cite> メソッドで S3 を設定し、S3 バケット名とオブジェクト名を指定して学習データをアップローとしています。</div>
</div>
<div class="line-block">
<div class="line">次の処理も改行して記載します。</div>
<div class="line">Amazon SageMaker SDK for Python の <a class="reference external" href="https://sagemaker.readthedocs.io/en/stable/api/utility/inputs.html#sagemaker.inputs.s3_input">s3_input</a> クラスのオプジェクトを生成しています。</div>
<div class="line">ここでは、その名の通り入力となる学習データが格納された S3 バケットと学習データのファイル形式 (CSV) を設定しています。</div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sess</span> <span class="o">=</span> <span class="n">sagemaker</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
</pre></div>
</div>
<p>Amazon SageMaker API およびその他の必要な AWS サービスとのやり取りを管理するための Session オブジェクトを作成しています。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">xgb</span> <span class="o">=</span> <span class="n">sagemaker</span><span class="o">.</span><span class="n">estimator</span><span class="o">.</span><span class="n">Estimator</span><span class="p">(</span>
  <span class="n">containers</span><span class="p">[</span><span class="n">my_region</span><span class="p">],</span>
  <span class="n">role</span><span class="p">,</span>
  <span class="n">train_instance_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
  <span class="n">train_instance_type</span><span class="o">=</span><span class="s1">&#39;ml.m4.xlarge&#39;</span><span class="p">,</span>
  <span class="n">output_path</span><span class="o">=</span><span class="s1">&#39;s3://{}/{}/output&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">prefix</span><span class="p">),</span>
  <span class="n">sagemaker_session</span><span class="o">=</span><span class="n">sess</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">上記の処理も改行して記載します。</div>
<div class="line">Amazon SageMaker SDK for Python の <a class="reference external" href="https://sagemaker.readthedocs.io/en/stable/api/training/estimators.html#sagemaker.estimator.Estimator">Estimator</a> クラスのオプジェクトを生成しています。</div>
</div>
<div class="line-block">
<div class="line">Estimator クラスにて、学習の設定を行います。</div>
<div class="line">パラメータ (Estimator クラスの引数) の意味について下記に示します。</div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>パラメータ (引数)</p></th>
<th class="head"><p>パラメータの意味</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>containers</p></td>
<td><div class="line-block">
<div class="line">学習に利用するコンテナイメージの URI を指定する。</div>
<div class="line">ここでは、組み込みアルゴリズムの XGBoost リリース 0.72 のコンテナイメージの URI を指定している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p>role</p></td>
<td><div class="line-block">
<div class="line">Amazon SageMaker にアタッチする IAM ロールの名前もしくは ARN を指定する。</div>
<div class="line">ここでは、前段で作成した IAM ロール (AmazonSageMakerFullAccess ポリシーが設定されたもの) を設定している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p>train_instance_count</p></td>
<td><div class="line-block">
<div class="line">学習用インスタンス数を設定する。</div>
<div class="line">2 以上を設定することで複数インスタンスでの分散学習の実行が可能である。</div>
<div class="line">ただし、独自アルゴリズムを利用する場合は分散学習に対応したコードを開発する必要がある。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p>train_instance_type</p></td>
<td><div class="line-block">
<div class="line">学習用インスタンスのインスタンスタイプを設定する。</div>
<div class="line">ML インスタンスとして様々なタイプが用意されており、学習の特性に応じたものを選択する。</div>
<div class="line">ここでは、汎用 (M4) の xlarge を設定している。その他に利用できるインスタンスタイプと料金は下記を参照のこと。</div>
<div class="line">- 「<a class="reference external" href="https://aws.amazon.com/jp/sagemaker/pricing/instance-types/">Amazon SageMaker ML インスタンスタイプ</a>」</div>
<div class="line">- 「<a class="reference external" href="https://aws.amazon.com/jp/sagemaker/pricing/">Amazon SageMaker の料金</a>」</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p>output_path</p></td>
<td><div class="line-block">
<div class="line">学習におけるアウトプット (モデルアーティファクトと出力ファイル) の出力先となる S3 バケットを指定する。</div>
<div class="line">このパラメータが設定されていない場合は、デフォルトバケットに出力される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p>sagemaker_session</p></td>
<td><p>Session オブジェクトを設定する。</p></td>
</tr>
</tbody>
</table>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
  <span class="n">xgb</span><span class="o">.</span><span class="n">set_hyperparameters</span><span class="p">(</span>
    <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">eta</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
    <span class="n">gamma</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">min_child_weight</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
    <span class="n">subsample</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
    <span class="n">silent</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">objective</span><span class="o">=</span><span class="s1">&#39;binary:logistic&#39;</span><span class="p">,</span>
    <span class="n">num_round</span><span class="o">=</span><span class="mi">100</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">上記の処理も改行して記載します。</div>
<div class="line">ここでは、XGBoost のハイパーパラメータを設定しています。</div>
<div class="line">ハイパーパラメータの値は機械学習モデルの精度に直結します。</div>
<div class="line">Amazon SageMaker にはハイパーパラメータを自動チューニングする機能がありますが、ここでは固定値として上記の値を設定しています。</div>
<div class="line">XGBoost で設定できるハイパーパラメータとそれぞれの意味は、「<a class="reference external" href="https://docs.aws.amazon.com/ja_jp/sagemaker/latest/dg/xgboost-72.html#xgboost-72-hyperparameters">XGBoost リリース 0.72 のハイパーパラメータ</a> 」に一覧でまとめられていますので、知りたい方は参照してください。</div>
</div>
</div>
</div>
<div class="section" id="id25">
<h3>(学習) XGBoost (組み込みアルゴリズム) を利用して学習を行う<a class="headerlink" href="#id25" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>学習の設定まで完了しましたので、ここからは実際に学習を行います。</p>
<div class="section" id="id26">
<h4>実行するコード<a class="headerlink" href="#id26" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>下記のコードをセルにコピー＆ペーストして実行してください。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">xgb</span><span class="o">.</span><span class="n">fit</span><span class="p">({</span><span class="s1">&#39;train&#39;</span><span class="p">:</span> <span class="n">s3_input_train</span><span class="p">})</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">なお、学習が開始されると下記の画像に示したような実行ログが出力されます。</div>
<div class="line">1 画面に収まらない量が出力されますが、ただの実行ログですので問題ありません。</div>
</div>
<a class="reference internal image-reference" href="../../_images/sagemaker-training-start.png"><img alt="../../_images/sagemaker-training-start.png" src="../../_images/sagemaker-training-start.png" style="width: 900px;" /></a>
<div class="line-block">
<div class="line">学習が完了すると、下記のように完了を示すメッセージが出力されます。</div>
<div class="line">このチュートリアルはデータ量が少ないため、数分で完了します。</div>
</div>
<a class="reference internal image-reference" href="../../_images/sagemaker-training-complete.png"><img alt="../../_images/sagemaker-training-complete.png" src="../../_images/sagemaker-training-complete.png" style="width: 900px;" /></a>
</div>
<div class="section" id="id27">
<h4>コードの解説<a class="headerlink" href="#id27" title="このヘッドラインへのパーマリンク">¶</a></h4>
<div class="line-block">
<div class="line">Amazon SageMaker における学習の実行は、<a class="reference external" href="https://sagemaker.readthedocs.io/en/stable/api/training/estimators.html#sagemaker.estimator.Estimator.fit">fit</a> メソッドに学習データが格納されている S3 バケットの所在を渡すだけで実行できます。</div>
<div class="line">fit メソッドを実行すると、学習ジョブが起動して XGBoost による機械学習モデルが構築されます。</div>
</div>
<div class="line-block">
<div class="line">実行ログを簡単に見てみましょう。</div>
<div class="line">Amazon SageMaker が背後で行っている処理を確認することができます。</div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>実行ログ</p></th>
<th class="head"><p>処理内容</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>2020-07-11 11:34:39 Starting - Starting the training job...</p></td>
<td><p>学習ジョブの開始</p></td>
</tr>
<tr class="row-odd"><td><p>2020-07-11 11:34:42 Starting - Launching requested ML instances......</p></td>
<td><p>学習用インスタンスの起動開始</p></td>
</tr>
<tr class="row-even"><td><p>2020-07-11 11:35:57 Starting - Preparing the instances for training......</p></td>
<td><p>学習を開始するためのインスタンスの準備開始</p></td>
</tr>
<tr class="row-odd"><td><p>2020-07-11 11:36:53 Downloading - Downloading input data</p></td>
<td><p>S3 バケットから学習データをダウンロード中</p></td>
</tr>
<tr class="row-even"><td><p>2020-07-11 11:37:39 Training - Downloading the training image...</p></td>
<td><p>トレーニングに利用する XGBoost の Docker コンテナイメージのダウンロード中</p></td>
</tr>
<tr class="row-odd"><td><p>2020-07-11 11:37:39 Uploading - Uploading generated training model</p></td>
<td><p>学習が完了し、アーティファクトを S3 バケットにアップロード中</p></td>
</tr>
<tr class="row-even"><td><p>Arguments: train</p></td>
<td><p>学習の実行を示すメッセージ</p></td>
</tr>
<tr class="row-odd"><td><p>[2020-07-11:11:37:34:INFO] Running standalone xgboost training.</p></td>
<td><div class="line-block">
<div class="line">XGBoost による学習の実行ログ</div>
<div class="line"><br /></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p>(中略)</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>2020-07-11 11:37:46 Completed - Training job completed</p></td>
<td><p>学習ジョブの完了</p></td>
</tr>
<tr class="row-even"><td><p>Training seconds: 53</p></td>
<td><p>トレーニングに要した時間 (秒)</p></td>
</tr>
<tr class="row-odd"><td><p>Billable seconds: 53</p></td>
<td><p>課金される時間 (秒)</p></td>
</tr>
</tbody>
</table>
<p>Amazon SageMaker は従量課金性であり、今回のトレーニングでは 53 秒分の課金がされることがわかります。</p>
<ul class="simple">
<li><p>(メモ) ビルトインアルゴリズムを利用することでコーディング量が減る。</p></li>
</ul>
</div>
</div>
<div class="section" id="id28">
<h3>(推論) 学習済モデルを推論用インスタンスにデプロイする<a class="headerlink" href="#id28" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="line-block">
<div class="line">学習を実行し、機械学習モデルの構築まで完了しました。</div>
<div class="line">ここでは機械学習モデルをデプロイします。</div>
<div class="line">デプロイとは、API サーバの構築。推論用インスタンスの作成、推論用コンテナとして機械学習モデルを起動する。</div>
</div>
<div class="section" id="id29">
<h4>実行するコード<a class="headerlink" href="#id29" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>下記のコードをセルにコピー＆ペーストして実行してください。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">xgb_predictor</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">deploy</span><span class="p">(</span><span class="n">initial_instance_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">instance_type</span><span class="o">=</span><span class="s1">&#39;ml.m4.xlarge&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>なお、デプロイが開始されると、下記の画像に示したように処理の進行とともに「- (ハイフン)」が出力されていきます。</p>
<a class="reference internal image-reference" href="../../_images/sagemaker-deploy-start.png"><img alt="../../_images/sagemaker-deploy-start.png" src="../../_images/sagemaker-deploy-start.png" style="width: 900px;" /></a>
<p>デプロイが完了すると、下記のように完了を示す「!」が出力されます。
デプロイ処理は数分で完了します。</p>
<a class="reference internal image-reference" href="../../_images/sagemaker-deploy-complete.png"><img alt="../../_images/sagemaker-deploy-complete.png" src="../../_images/sagemaker-deploy-complete.png" style="width: 900px;" /></a>
</div>
<div class="section" id="id30">
<h4>コードの解説<a class="headerlink" href="#id30" title="このヘッドラインへのパーマリンク">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">xgb_predictor</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">deploy</span><span class="p">(</span>
  <span class="n">initial_instance_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
  <span class="n">instance_type</span><span class="o">=</span><span class="s1">&#39;ml.m4.xlarge&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">この処理も改行して記載します。</div>
<div class="line"><a class="reference external" href="https://sagemaker.readthedocs.io/en/stable/api/training/estimators.html#sagemaker.estimator.Estimator.deploy">deploy</a> メソッドを使って、機械学習モデルのデプロイを実行します。</div>
<div class="line">ここで設定するパラメータ (引数) とそれぞれの意味を下記に示します。</div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>パラメータ (引数)</p></th>
<th class="head"><p>パラメータの意味</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>initial_instance_count</p></td>
<td><div class="line-block">
<div class="line">推論用インスタンス数を設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p>instance_type</p></td>
<td><div class="line-block">
<div class="line">推論用インスタンスのインスタンスタイプを設定する。</div>
<div class="line">ML インスタンスとして様々なタイプが用意されており、学習の特性に応じたものを選択する。</div>
<div class="line">ここでは、汎用 (M4) の xlarge を設定している。その他に利用できるインスタンスタイプと料金は下記を参照のこと。</div>
<div class="line">- 「<a class="reference external" href="https://aws.amazon.com/jp/sagemaker/pricing/instance-types/">Amazon SageMaker ML インスタンスタイプ</a>」</div>
<div class="line">- 「<a class="reference external" href="https://aws.amazon.com/jp/sagemaker/pricing/">Amazon SageMaker の料金</a>」</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line">推論用インスタンスを作成して、S3 バケットから学習済の機械学習モデルを、Amazon ECR から推論用コンテナイメージをダウンロードして、推論用コンテナを起動します。</div>
<div class="line">アプリなどからアクセスするためのエンドポイントを作成しています。エンドポイントには HTTPS で接続します。</div>
</div>
</div>
</div>
<div class="section" id="id33">
<h3>(推論) テストデータを使って顧客が申し込みを行ったかを予測する<a class="headerlink" href="#id33" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="section" id="id34">
<h4>実行するコード<a class="headerlink" href="#id34" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>下記のコードをセルにコピー＆ペーストして実行してください。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">test_data_array</span> <span class="o">=</span> <span class="n">test_data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;y_no&#39;</span><span class="p">,</span> <span class="s1">&#39;y_yes&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span> <span class="c1">#load the data into an array</span>
<span class="n">xgb_predictor</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="s1">&#39;text/csv&#39;</span> <span class="c1"># set the data type for an inference</span>
<span class="n">xgb_predictor</span><span class="o">.</span><span class="n">serializer</span> <span class="o">=</span> <span class="n">csv_serializer</span> <span class="c1"># set the serializer type</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">xgb_predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_data_array</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="c1"># predict!</span>
<span class="n">predictions_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="c1"># and turn the prediction into an array</span>
<span class="k">print</span><span class="p">(</span><span class="n">predictions_array</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
<p>実行した結果出力される <cite>(12357,)</cite> は、予測した顧客の数 (12,357人) です。</p>
</div>
<div class="section" id="id35">
<h4>コードの解説<a class="headerlink" href="#id35" title="このヘッドラインへのパーマリンク">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">test_data_array</span> <span class="o">=</span> <span class="n">test_data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;y_no&#39;</span><span class="p">,</span> <span class="s1">&#39;y_yes&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span> <span class="c1">#load the data into an array</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">前段でデータを学習データとテストデータに分割しました。</div>
<div class="line">その際には単純に分割しただけで、テストデータには正解の値 (「y_yes」と「y_no」) が含まれます。</div>
<div class="line">顧客の属性情報から申し込みを行うか否かを予測したいので、正解の値を削除 (drop) しています。</div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">xgb_predictor</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="s1">&#39;text/csv&#39;</span> <span class="c1"># set the data type for an inference</span>
<span class="n">xgb_predictor</span><span class="o">.</span><span class="n">serializer</span> <span class="o">=</span> <span class="n">csv_serializer</span> <span class="c1"># set the serializer type</span>
</pre></div>
</div>
<p>推論に用いるテストデータの Content type とシリアライザのタイプに CSV 用のものを指定しています。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">predictions</span> <span class="o">=</span> <span class="n">xgb_predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_data_array</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="c1"># predict!</span>
</pre></div>
</div>
<p>テストデータを推論エンドポイントに送信して、推論結果を得ています。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">predictions_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="c1"># and turn the prediction into an array</span>
</pre></div>
</div>
<p>推論結果がカンマ区切りのテキストデータで返されるので、後続の精度の評価をするために Numpy の <a class="reference external" href="https://numpy.org/doc/1.18/reference/generated/numpy.fromstring.html">fromstring</a> メソッドを使って Array に変換しています。</p>
</div>
</div>
<div class="section" id="id36">
<h3>(推論) 精度の評価を行う<a class="headerlink" href="#id36" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="line-block">
<div class="line">推論結果を得ることができましたので、最後に精度の評価を行います。</div>
<div class="line">二値分類の精度評価においてよく利用される「混同行列 (confusion matrix)」を使います。</div>
</div>
<ul class="simple">
<li><p>(メモ) ROC 曲線、AUC を利用しても良いかも。</p></li>
<li><p>(メモ) アプリからの接続方法についても言及する。</p></li>
</ul>
<div class="section" id="id37">
<h4>実行するコード<a class="headerlink" href="#id37" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>下記のコードをセルにコピー＆ペーストして実行してください。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cm</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">crosstab</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;y_yes&#39;</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">predictions_array</span><span class="p">),</span> <span class="n">rownames</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Observed&#39;</span><span class="p">],</span> <span class="n">colnames</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Predicted&#39;</span><span class="p">])</span>
<span class="n">tn</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">];</span> <span class="n">fn</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">];</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">];</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">];</span> <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">tp</span><span class="o">+</span><span class="n">tn</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">tp</span><span class="o">+</span><span class="n">tn</span><span class="o">+</span><span class="n">fp</span><span class="o">+</span><span class="n">fn</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">{0:&lt;20}{1:&lt;4.1f}%</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Overall Classification Rate: &quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;{0:&lt;15}{1:&lt;15}{2:&gt;8}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Predicted&quot;</span><span class="p">,</span> <span class="s2">&quot;No Purchase&quot;</span><span class="p">,</span> <span class="s2">&quot;Purchase&quot;</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;Observed&quot;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;{0:&lt;15}{1:&lt;2.0f}% ({2:&lt;}){3:&gt;6.0f}% ({4:&lt;})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;No Purchase&quot;</span><span class="p">,</span> <span class="n">tn</span><span class="o">/</span><span class="p">(</span><span class="n">tn</span><span class="o">+</span><span class="n">fn</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span><span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="o">/</span><span class="p">(</span><span class="n">tp</span><span class="o">+</span><span class="n">fp</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">fp</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;{0:&lt;16}{1:&lt;1.0f}% ({2:&lt;}){3:&gt;7.0f}% ({4:&lt;}) </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Purchase&quot;</span><span class="p">,</span> <span class="n">fn</span><span class="o">/</span><span class="p">(</span><span class="n">tn</span><span class="o">+</span><span class="n">fn</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span><span class="n">fn</span><span class="p">,</span> <span class="n">tp</span><span class="o">/</span><span class="p">(</span><span class="n">tp</span><span class="o">+</span><span class="n">fp</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">tp</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="id38">
<h4>コードの解説<a class="headerlink" href="#id38" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>Pandas の <a class="reference external" href="https://pandas.pydata.org/pandas-docs/version/1.0.3/reference/api/pandas.crosstab.html">crosstab</a> 関数を使って、推論結果のクロス集計を行っています。</p>
<p>ここで、精度評価で利用している混同行列について補足します。</p>
<a class="reference internal image-reference" href="../../_images/confusion-matrix.png"><img alt="../../_images/confusion-matrix.png" src="../../_images/confusion-matrix.png" style="width: 450px;" /></a>
<div class="line-block">
<div class="line">行方向 (縦軸) が「正解 (観測; Observed)」、列方向 (横軸) が「予測 (Predicted)」を表します。</div>
<div class="line">正解 (2種類) * 予測 (2種類) で、下記に示す 4 つの指標があります。</div>
<div class="line">混同行列という名前の通りで混乱しやすいですが、Positive/Negative はあくまで「予測」に対してかかります。</div>
<div class="line">その予測の正解と不正解により、True/Negative が付いていると考えると理解しやすいと思います。</div>
</div>
<ul class="simple">
<li><p>True Positive (TP): 預金証書 (CD) を申し込むと予測して、実際に申し込んだ顧客の数</p></li>
<li><p>False Poritive (FP): 預金証書 (CD) を申し込むと予測したが、実際には申し込まなかった顧客の数</p></li>
<li><p>True Negative (TN): 預金証書 (CD) を申し込まないと予測して実際に申し込まなかった顧客の数</p></li>
<li><p>False Negative (FN): 預金証書 (CD) を申し込まないと予測したが、実際には申し込んだ顧客の数</p></li>
</ul>
</div>
<div class="section" id="id39">
<h4>推論結果についての考察<a class="headerlink" href="#id39" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>上記のコードを実行すると、下記のような出力結果を得られます。</p>
<a class="reference internal image-reference" href="../../_images/sagemaker-predict-confusion-matrix.png"><img alt="../../_images/sagemaker-predict-confusion-matrix.png" src="../../_images/sagemaker-predict-confusion-matrix.png" style="width: 450px;" /></a>
<div class="line-block">
<div class="line"><cite>Overall Classification Rate</cite> で示されている数値が正解率であり、今回は 89.5% でした。</div>
<div class="line">True Negative が 90% である一方で、True Poritive は 65% とかなり低いように見えます。</div>
<div class="line">なぜでしょうか？</div>
</div>
<div class="line-block">
<div class="line">学習データ (train_data) には、28,831 人分の顧客データを利用しました。</div>
<div class="line">このうち、預金証書 (CD) を申し込んだ顧客数 (<cite>y_yes</cite> が 1 の合計) と申し込まなかった (<cite>y_no</cite> が 1 の合計) を確認してみます。</div>
</div>
<a class="reference internal image-reference" href="../../_images/sagemaker-predict-train-data.png"><img alt="../../_images/sagemaker-predict-train-data.png" src="../../_images/sagemaker-predict-train-data.png" style="width: 450px;" /></a>
<div class="line-block">
<div class="line">前者が 3,219 人であることに対して、後者は 25,612 人と 5 倍近い差があります。</div>
<div class="line">預金証書 (CD) を申し込んだ顧客数のデータを増やすと、True Positive の割合も高くなり、精度を高められる可能性があります。</div>
<div class="line">二値分類においては、学習データとなる正解データは十分な量を同程度用意することが望ましいと言われています。</div>
<div class="line">今回のチュートリアルでもその一端を垣間見ることができました。</div>
</div>
</div>
</div>
<div class="section" id="id40">
<h3>(後片付け) 作成したリソースを削除する<a class="headerlink" href="#id40" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="line-block">
<div class="line">以上で「開発」「学習」「推論」を一通り実施することができました。</div>
<div class="line">課金対象のリソースがありますので、課金を防ぐためにリソースを削除します。</div>
</div>
<ul class="simple">
<li><p>(メモ) 任意で実施。課金が気になる場合は必ず実施する。</p></li>
<li><p>(メモ) 課金されるリソース・課金されないリソースを書いておく。</p></li>
</ul>
<div class="section" id="id41">
<h4>実行するコード<a class="headerlink" href="#id41" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>下記のコードをセルにコピー＆ペーストして実行してください。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sagemaker</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span><span class="o">.</span><span class="n">delete_endpoint</span><span class="p">(</span><span class="n">xgb_predictor</span><span class="o">.</span><span class="n">endpoint</span><span class="p">)</span>
<span class="n">bucket_to_delete</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s1">&#39;s3&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Bucket</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">)</span>
<span class="n">bucket_to_delete</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="id42">
<h4>コードの解説<a class="headerlink" href="#id42" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>上記のコードを実行することによって、下記が実行されます。</p>
<ul class="simple">
<li><p>推論用エンドポイントの削除</p></li>
<li><p>S3 バケット内のオブジェクトの削除</p></li>
</ul>
</div>
<div class="section" id="id43">
<h4>その他のリソースの削除<a class="headerlink" href="#id43" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>この他にも「ノートブックインスタンス」と「CloudWatch Logs」が課金対象となりますので、削除忘れに注意してください。
ノートブックインスタンスは「停止」と「削除」の 2 段階での対応が必要です。</p>
<div class="line-block">
<div class="line">まず、ノートブックインスタンスの削除を行います。</div>
<div class="line">JupyterLab のタブは、Web ブラウザの「×」ボタンなどで閉じてください。</div>
</div>
<div class="line-block">
<div class="line">AWS マネジメントコンソールのノートブックインスタンスの画面に移動します。</div>
<div class="line">削除対象のノートブックインスタンスをラジオボタンで選択し、「アクション」で「停止」を選択します。</div>
<div class="line">停止処理に移ると、「ステータス」が「InService」から「Stopping」に移行しますので、数分待ちます。</div>
</div>
<a class="reference internal image-reference" href="../../_images/sagemaker-notebook-delete-1.png"><img alt="../../_images/sagemaker-notebook-delete-1.png" src="../../_images/sagemaker-notebook-delete-1.png" style="width: 900px;" /></a>
<p>「ステータス」が「Stopped」になったことを確認して、「アクション」で「削除」をクリックします。</p>
<a class="reference internal image-reference" href="../../_images/sagemaker-notebook-delete-2.png"><img alt="../../_images/sagemaker-notebook-delete-2.png" src="../../_images/sagemaker-notebook-delete-2.png" style="width: 900px;" /></a>
<p>ノートブックインスタンスの削除を確認するウィンドウが表示されますので、「削除」をクリックします。</p>
<a class="reference internal image-reference" href="../../_images/sagemaker-notebook-delete-3.png"><img alt="../../_images/sagemaker-notebook-delete-3.png" src="../../_images/sagemaker-notebook-delete-3.png" style="width: 450px;" /></a>
<div class="line-block">
<div class="line">「ステータス」が「Deleting」に移行し、数分待つとノートブックインスタンスが画面からなくなります。</div>
<div class="line">これでノートブックインスタンスの削除は完了です。</div>
</div>
<div class="line-block">
<div class="line">次に、CloudWatch Logs の削除を行います。</div>
<div class="line">AWS マネジメントコンソールのトップ画面などから「CloudWatch」を検索して移動します。</div>
</div>
<a class="reference internal image-reference" href="../../_images/cloudwatch-logs-delete-1.png"><img alt="../../_images/cloudwatch-logs-delete-1.png" src="../../_images/cloudwatch-logs-delete-1.png" style="width: 900px;" /></a>
<p>CloudWatch の画面に移動できたら、左側のメニューから「ロググループ」を選択します。</p>
<a class="reference internal image-reference" href="../../_images/cloudwatch-logs-delete-2.png"><img alt="../../_images/cloudwatch-logs-delete-2.png" src="../../_images/cloudwatch-logs-delete-2.png" style="width: 450px;" /></a>
<div class="line-block">
<div class="line">ロググループの画面に移動できたら、検索バーに「sagemaker」と入力してログを検索します。</div>
<div class="line">削除するログを全て選択して、「アクション」で「削除」をクリックします。</div>
</div>
<a class="reference internal image-reference" href="../../_images/cloudwatch-logs-delete-3.png"><img alt="../../_images/cloudwatch-logs-delete-3.png" src="../../_images/cloudwatch-logs-delete-3.png" style="width: 900px;" /></a>
<p>ロググループの削除を確認するウィンドウが表示されますので、「削除」をクリックします。</p>
<a class="reference internal image-reference" href="../../_images/cloudwatch-logs-delete-4.png"><img alt="../../_images/cloudwatch-logs-delete-4.png" src="../../_images/cloudwatch-logs-delete-4.png" style="width: 450px;" /></a>
<p>ロググループが画面からなくなったら削除は完了です。</p>
<div class="line-block">
<div class="line">S3 バケットと IAM ロールも作成しましたが、これらは存在するだけでは課金されません。</div>
<div class="line">それぞれのサービスの画面から必要に応じて削除してください。</div>
</div>
</div>
</div>
</div>
<div class="section" id="id44">
<h2>考察<a class="headerlink" href="#id44" title="このヘッドラインへのパーマリンク">¶</a></h2>
<ul class="simple">
<li><p>(メモ) ここまででかなりの長さになることが予想されるので、連載を分けた方が良いかも。</p></li>
<li><p>(メモ) 自分のビジネス課題に応用するにはどうすれば良いのか？</p></li>
<li><p>(メモ) XGBoost の詳細を知る必要があるか？ (下記あたりを抑えておけば良いのでは？)</p>
<ul>
<li><p>どんな課題に適用できるか？</p></li>
<li><p>どんなデータを準備すれば良いか？</p></li>
<li><p>どうやって利用するか？</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id45">
<h2>まとめ<a class="headerlink" href="#id45" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="line-block">
<div class="line">今回の記事では、Amazon SageMaker を実際に使って開発・学習・推論をする方法についてご説明させていただきました。</div>
<div class="line">次回は、Amazon SageMaker Studio の使い方についてみていきたいと思います。</div>
</div>
</div>
<div class="section" id="id46">
<h2>参考文献<a class="headerlink" href="#id46" title="このヘッドラインへのパーマリンク">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://aws.amazon.com/jp/getting-started/hands-on/build-train-deploy-machine-learning-model-sagemaker/">「機械学習モデルの構築およびトレーニング、デプロイ with Amazon SageMaker」</a></p></li>
<li><p><a class="reference external" href="https://docs.aws.amazon.com/ja_jp/sagemaker/latest/dg/whatis.html">「Amazon SageMaker 開発者ガイド」</a></p></li>
<li><p><a class="reference external" href="https://aws.amazon.com/jp/sagemaker/pricing/instance-types/">「Amazon SageMaker ML インスタンスタイプ」</a></p></li>
<li><p><a class="reference external" href="https://aws.amazon.com/jp/sagemaker/pricing/">「Amazon SageMaker の料金」</a></p></li>
</ul>
</div>
<hr class="docutils" />
<div class="section" id="id51">
<h2>著者紹介<a class="headerlink" href="#id51" title="このヘッドラインへのパーマリンク">¶</a></h2>
<a class="reference internal image-reference" href="../../_images/myphoto3.jpg"><img alt="../../_images/myphoto3.jpg" class="align-right" src="../../_images/myphoto3.jpg" style="width: 157.65px; height: 225.0px;" /></a>
<p>菊地 貴彰 (KIKUCHI Takaaki)</p>
<p>株式会社 NTT データ システム技術本部 デジタル技術部 Agile Professional 担当</p>
<p>大学・大学院では、機械学習を専攻。
ベイズ的枠組みを用いて、複数の遺伝子のデータから遺伝子どうしの相互作用ネットワークの推定に関する研究を行った。</p>
<p>株式会社NTTデータに入社後は、法人や金融のシステム開発のシステム基盤担当としてキャリアを積み、
現在はデジタル技術や Agile 開発を専門に扱う組織でシステム開発全般を担当する。
2019, 2020 APN AWS Top Engineers, Japan APN Ambassador 2020 に選出。</p>
<p>本連載の内容に対するご意見・ご質問は twitter: &#64;kikuchitk7 まで。</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, kikuchitk7

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>