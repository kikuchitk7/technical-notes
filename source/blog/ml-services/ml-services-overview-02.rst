






Amazon SageMaker とは
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
これが必要
上の機能群よりも上にあった方がいい？要検討
SageMaker での開発は Python で。
機械学習のフレームワークの多くが Python ベース
scikit-learn XGBoost TensorFlow

アーキテクチャ図のようなもので SageMaker の全体像を定義する

インフラを管理するサービス LA: architecture 3
ノートブックインスタンス
学習用インスタンス
推論用インスタンス
Docker コンテナ

Amazon SageMaker の使い方
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
| Amazon SageMaker の使い方を機械学習の開発の流れ (ワークフロー) に沿って見ていきたいと思います。
| 機械学習モデルを開発する流れは「事前準備」「開発」「学習」「推論」の4ステップとなります。

事前準備
**************
- | 学習データ (機械学習モデルの学習に用いるデータ) を収集し、Amazon S3 に格納する。
  | Amazon SageMaker では収集の仕組みは提供されていないので、例えば、Amazon Kinesis など他のサービス・手段を使って収集する。
- 機械学習モデルの開発環境となるノートブックインスタンス (Jupyter Notebook の実行環境) を構築する。
- 学習データに対して前処理 (欠損値の処理、変換など) をする。

データ可視化についても入れる
データの分析
エンジニアリング pandas numpy EMR one-hot-encoding
synthesize データの水増し　図の向きを帰るとか
conversion csv to numpy
split train test
from other service like EMR to another setvice like S3
(図をいれる 21)

開発
**************
- 機械学習モデルの構築 (Python によるコーディング) をする。

(図をいれる 22+23)

学習
**************
- Amazon ECR から学習用の Docker コンテナイメージをダウンロードして、学習用インスタンスとしてコンテナを起動する。
- Amazon S3 から学習用インスタンスに学習データをダウンロードして、機械学習モデルの学習を行う。
- 学習した結果得られた機械学習モデルを Amazon S3 に格納する。
- 学習用インスタンスは自動的に停止・削除される。
- 混同行列などの何らかの評価手法を使って、機械学習モデルの精度の評価を行う。
- | 精度がビジネスの要件を満たせない場合は、原因の分析を行って前のステップに戻ってやり直す。
  | 必要に応じて、学習データの再収集や機械学習モデルの再構築をして精度の改善を図る。

(図をいれる 24+25)

推論
**************
- | Amazon ECR から推論用の Docker コンテナイメージをダウンロードして推論用インスタンスを起動する。
  | Amazon S3 から機械学習モデルをダウンロードし、推論インスタンスにデプロイする。
  | 他のアプリからの接続ポイントとなる推論エンドポイントを作成する。 
- 機械学習モデルの監視

(図をいれる 26+27)


Amazon SageMaker の機能
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
| Amazon SageMaker では、機械学習のワークフロー全体に渡って様々な機能が提供されています。(サービス名は省略表記で記載)
| 必ずしも全ての機能を利用する必要はなく、必要に応じて個別に利用することが可能です。
| 例えば、機械学習モデルの開発環境としてノートブックインスタンスだけを利用するといったことが可能です。

下記を図で示す。

事前準備
- データの収集　別の仕組みを利用して収集し、Amazon S3 に保管
- データの前処理　Ground Truth, Processing

開発
- モデルの構築　ビルトインアルゴリズム/Marketplace/独自アルゴリズム、Jupyter notebook/Jupyter Lab/Notebooks

学習
- モデルの学習　Experiments,Debugger
- モデルの評価　同上

推論
- モデルのデプロイ　Model hosting
- モデルの監視　Model Monitor, A2I

(開発〜学習) Autopilot
(全体) Studio


Amazon SageMaker でのモデルの構築方法
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
| Amazon SageMaker を使って機械学習モデルを構築する方法についてもう少し詳細に説明します。
| Amazon SageMaker では、下記のいずれかのパターンで構築します。それぞれのパターンの説明と導入の難易度についてまとめます。

.. list-table::
    :header-rows: 1

    * - 構築パターン
      - 構築パターンの説明
      - 導入の難易度
    * - ビルトインアルゴリズムを利用する
      - | AWS が用意した (Amazon SageMaker に組み込んだ) 学習アルゴリズムを使ってモデルを構築する。
        | XGBoost 
        | Amazon SageMaker に最適化されており、最も簡便に利用することができる。
        | 例えば、設定 (パラメータ) を変えるだけで、コードを追加せずに分散学習を行うことができる。
      - 低
    * - AWS Marketplace で購入したを利用する
      - | サードパーティが AWS Marketplace に出品した機械学習アルゴリズムを使ってモデルを構築する。
        | 購入処理が必要となるが、導入の難易度はビルトインアルゴリズムと同程度である。
      - 低
    * - 独自にアルゴリズムを実装する
      - | 機械学習アルゴリズムの選定や実装を利用者自身で行う。
        | SageMaker SDK を使って
      - 高

(Marketplace の図をいれる)

| ビルトインアルゴリズムには、昨今注目を集めている深層学習 (ディープラーニング) を使うアルゴリズムから、XGBoost などの深層学習を使わないアルゴリズムまで多数用意されています。
| 導入の難易度やビジネスへの導入スピードを考えて、まずはビルトインアルゴリズムの中に自身のビジネス課題に対応できるものがないかを確認します。
| 対応するものがない場合は AWS Marketplace で探し、それでも対応するものがない場合は独自にアルゴリズムを実装することを考えることが望ましいでしょう。


Amazon SageMaker の利用例
-----------------------------------
| ここでは、Amazon SageMaker の利用イメージをつかんでいただくために、ビルトインアルゴリズムを使って機械学習モデルを開発・学習・推論を行ってみます。
| 「[Build, Train, and Deploy a Machine Learning Model with Amazon SageMaker](https://aws.amazon.com/jp/getting-started/hands-on/build-train-deploy-machine-learning-model-sagemaker/)」というチュートリアルがありますので、これを利用します。
| 30分程度で実施できるので、是非ご自身でも試してみてください。


チュートリアルの内容
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
- 問題の概要：銀行の見込み顧客の予測
- 問題の詳細：銀行の過去の顧客のデータを基にして、見込み顧客の予測モデルを構築し、新規に口座を開設してくれるか判別したい。
- 機械学習のタイプ：分類問題 (顧客に口座開設の見込みがあるか、ないかの分類)
- 利用するデータ：UCI (カリフォルニア大学アーバイン校) が提供する Machine Learning Repository の "[Bank Marketing Data Set](https://archive.ics.uci.edu/ml/datasets/bank+marketing)" を利用する。
- データの概要：ポルトガルの金融機関が過去に行ったダイレクトマーケティングキャンペーンのデータ。年齢、職業、婚姻歴、ローンの有無など口座開設の判断材料になりそうなデータ (特徴量、説明変数) と実際に口座開設したかのデータ (目的変数) が含まれる。
- 

1. データの収集
**********************


2. データの前処理
***********************


3. モデルの構築
**********************


4. モデルの学習
**********************


5. モデルの評価
********************


6. モデルのデプロイ
**************************


7.モデルの監視
**************************
| 今回は Amazon SageMaker の基本的な使い方の紹介であるため、割愛させていただきます。
| Amazon SageMaker Model Monitor や Amazon A2I を利用して精度の監視を行います。

Amazon SageMaker で提供される機能
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
| Amazon SageMaker で提供されている機能を、「AWS ML スタック」で取り上げられている機能を中心にして、概要をまとめます。
| 読者の多くは東京リージョンでの利用を想定していると考えられるため、東京リージョンでの利用可否についても記載します。
| 2020年5月20日時点の公開情報に基づいていて作成しますが、今後のアップデートにより変わる可能性がありますので、ご注意ください。


.. list-table::
    :header-rows: 1

    * - サービス名
      - 機能の説明
      - 東京での利用可否
    * - `Amazon SageMaker <https://aws.amazon.com/jp/sagemaker/>`_
      - | 機械学習ワークフローの全体に渡って、開発者やデータサイエンティストが機械学習モデルを開発するための便利な機能が多数提供する。
        | マネージドサービスとして提供されており、利用者は機械学習モデルの開発に集中することができる。
      - ○
    * - `Amazon SageMaker Ground Truth <https://aws.amazon.com/jp/sagemaker/groundtruth/>`_
      - | Ground Truth とは「教師データにおける正解」であり、画像のラベリングなどを支援する機能。
        | 自社メンバや社外のベンダ、`Amazon Mechanical Turk <https://www.mturk.com/>`_ への作業のアウトソーシングも可能。
        | 自動ラベル付け機能も提供されており、ラベル付け作業の効率化も可能。
      - ○
    * - Amazon SageMaker Studio
      - | 機械学習モデルを効率的に開発・学習・推論をするための Web ブラウザベースの統合開発環境 (IDE) を提供する。
        | 認証方法として、AWS IAM だけでなく、AWS SSO (シングルサインオン) もサポートしており、AWS マネジメントコンソールを経由せずに Amazon SageMaker Studio 用の URL に直接サインインすることが可能。
        | 下記に示す Amazon SageMaker の各機能と統合されており、シームレスに利用することができる。
        | - Amazon SageMaker Notebooks
        | - Amazon SageMaker Experiments
        | - Amazon SageMaker Autopilot
        | - Amazon SageMaker Debugger
        | - Amazon SageMaker Model Monitor
        | 2020年5月20日時点では、オハイオ、バージニア北部、オレゴン、アイルランドのみサポートされている。
      - ×
    * - Amazon SageMaker Notebooks
      - | Amazon SageMaker Studio に統合されている完全マネージドな JupyterLab ベースのノートブック。
        | Amazon SageMaker のノートブックインスタンスとは異な利、利用者側でインスタンスタイプの設定、起動・停止などを意識する必要がない。
      - ×
    * - Amazon SageMaker Processing
      - データの前処理や後処理をバッチ処理で実行可能。
      - ○
    * - `AWS Marketplace <https://aws.amazon.com/marketplace/solutions/machine-learning/>`_
      - | サードパーティ製の機械学習モデルの購入して、Amazon SageMaker での利用が可能。
        | 利用者が構築した機械学習モデルを出品することも可能。
      - ○
    * - Amazon SageMaker Experiments
      - 学習の実行や学習の結果生成したモデルやハイパーパラメータ、精度などのメトリクスの一元的な管理が可能。
      - ○
    * - `Amazon SageMaker Autopilot <https://aws.amazon.com/jp/sagemaker/autopilot/>`_
      - | 回帰 (線形回帰) と分類 (二値/多値分類) に対する AutoML 機能を提供する。
        | 表形式の学習データをインプットとして、数クリックするだけで機械学習モデルの構築が可能。
        | 機械学習ワークフローのうちの「データの前処理」・「モデルの構築」・「モデルの学習」・「モデルの評価」を自動で実行する。
        | 機械学習モデル以外のアウトプットとして、下記の2つの Jupyter notebook 形式でが出力されるので、処理内容のホワイトボックス化が可能。
        | - 候補生成ノートブック：推奨される前処理、機械学習アルゴリズム、ハイパーパラメータ (機械学習アルゴリズムの設定値) の探索範囲を提示
        | - データ探索ノートブック：学習データの分析結果を提示
      - ×
    * - Amazon SageMaker Debugger
      - ルールを定義して、Amazon S3 に出力される学習の途中結果 (テンソルデータ) を監視、記録、分析し、学習の異常を検出することが可能。
      - ○
    * - 自動モデル調整
      - ベイズ最適化もしくはランダム探索によるハイパーパラメータのチューニングを自動で実施することが可能。
      - ○
    * - Amazon SageMaker Model Monitor
      - | 本番環境にデプロイした推論エンドポイントの継続的な監視が可能。
        | ユーザの行動変化などによる予測精度の低下の検知が可能。
      - ○
    * - | `Amazon Augmented AI (A2I) <https://aws.amazon.com/jp/augmented-ai/>`_
        | ※ プレビュー
      - | 信頼性の低い推論結果に対する人間の確認と修正をするためのワークフローの構築が可能。
        | 例えば、手書き文字認識の結果の確認と修正と実施する。
      - ○
    * - `Amazon SageMaker Neo <https://aws.amazon.com/jp/sagemaker/neo/>`_
      - 機械学習モデルを AWS IoT Greengrass (エッジデバイス) などで高速に動作させるように変換できる機能。
      - ○
